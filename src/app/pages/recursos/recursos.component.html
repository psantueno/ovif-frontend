<div class="recursos-page">
  <div class="page-header">
    <app-back-button text="Volver" [link]="['/panel-carga-mensual']"></app-back-button>

    <div class="context">
      <h1>Carga de recursos</h1>
      <p class="municipio">Municipio: <strong>{{ municipioNombre }}</strong></p>
      <p class="ejercicio" *ngIf="mesActualLabel">{{ mesActualLabel }}</p>
    </div>
  </div>

  <section class="status-card" *ngIf="mesCerrado || mensaje">
    <div *ngIf="mesCerrado" class="alert alert--warning">
      Este mes está cerrado. Las modificaciones no se guardarán.
    </div>
    <div
      *ngIf="mensaje"
      class="alert"
      [ngClass]="mensaje.tipo === 'info' ? 'alert--success' : 'alert--error'"
    >
      {{ mensaje.texto }}
    </div>
  </section>

  <section
    class="gastos-tabs recursos-tabs"
    role="tablist"
    aria-label="Modos de carga de recursos"
  >
    <button
      type="button"
      id="tab-manual"
      role="tab"
      class="gastos-tabs__button"
      [class.is-active]="vistaActual === 'manual'"
      [attr.aria-selected]="vistaActual === 'manual'"
      aria-controls="panel-manual"
      (click)="cambiarVista('manual')"
    >
      <mat-icon aria-hidden="true">edit</mat-icon>
      <span>Carga manual</span>
    </button>
    <button
      type="button"
      id="tab-masiva"
      role="tab"
      class="gastos-tabs__button"
      [class.is-active]="vistaActual === 'masiva'"
      [attr.aria-selected]="vistaActual === 'masiva'"
      aria-controls="panel-masiva"
      (click)="cambiarVista('masiva')"
    >
      <mat-icon aria-hidden="true">upload_file</mat-icon>
      <span>Importar desde archivo</span>
    </button>
  </section>

  <section
    class="recursos-card"
    *ngIf="vistaActual === 'manual'"
    id="panel-manual"
    role="tabpanel"
    aria-labelledby="tab-manual"
  >
    <header class="recursos-card__header">
      <div>
        <h2>Importes percibidos</h2>
        <p>Ingresá los datos correspondientes a cada partida para el período seleccionado.</p>
      </div>
      <div class="recursos-card__total">
        <span>Total percibido</span>
        <strong>{{ totalImportes | number: '1.0-2' }}</strong>
      </div>
    </header>

    <form class="recursos-form" (ngSubmit)="onSubmitGuardar()" novalidate>
      <div class="tabla-wrapper">
        <table class="recursos-tabla">
          <thead>
            <tr>
              <th>Partida</th>
              <th>Importe Percibido</th>
              <th>Total de Contribuyentes</th>
              <th>Contribuyentes que Pagaron</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="cargandoPartidas">
              <td colspan="4" class="tabla-info">
                <div class="tabla-loader" role="status" aria-live="polite">
                  <span class="tabla-loader__spinner" aria-hidden="true"></span>
                  <span class="tabla-loader__label">Cargando partidas...</span>
                </div>
              </td>
            </tr>
            <tr *ngIf="!cargandoPartidas && errorAlCargarPartidas">
              <td colspan="4" class="tabla-info tabla-info--error">No pudimos obtener las partidas. Intentá nuevamente.</td>
            </tr>
            <tr
              *ngIf="!cargandoPartidas && !errorAlCargarPartidas && partidasPlanas.length === 0"
            >
              <td colspan="4" class="tabla-info">No hay partidas de recursos disponibles.</td>
            </tr>
            <ng-container *ngIf="!cargandoPartidas && !errorAlCargarPartidas">
              <ng-container *ngFor="let partida of partidasPlanas">
                <tr
                  [class.grupo]="!partida.node.carga"
                  [class.tiene-error]="partida.node.errorImporte || partida.node.errorContribuyentes || partida.node.errorPagaron"
                >
                  <td
                    [attr.colspan]="partida.node.carga ? null : 4"
                    [style.padding-left.px]="partida.nivel * 20 + 4"
                  >
                    <span
                      [class.partida-titulo]="!partida.node.carga"
                      [class.partida-item]="partida.node.carga"
                    >
                      {{ partida.node.descripcion }}
                    </span>
                  </td>
                  <td *ngIf="partida.node.carga" class="importe">
                    <input
                      type="text"
                      class="importe-input"
                      [class.input-error]="partida.node.errorImporte"
                      [name]="'importe_' + partida.node.codigo"
                      [attr.id]="'importe_' + partida.node.codigo"
                      [readOnly]="mesCerrado"
                      inputmode="decimal"
                      (keydown)="permitirSoloNumeros($event)"
                      (paste)="sanearPegado($event, partida.node, 'importe')"
                      [(ngModel)]="partida.node.importePercibidoTexto"
                      (ngModelChange)="updateCampo(partida.node, 'importe', $event)"
                      [ngModelOptions]="{ standalone: true }"
                    />
                  </td>
                  <td *ngIf="partida.node.carga" class="cantidad">
                    <ng-container *ngIf="!partida.node.soloImporte; else sinDatoContribuyentes">
                      <input
                        type="text"
                        class="cantidad-input"
                        [class.input-error]="partida.node.errorContribuyentes"
                        [name]="'contribuyentes_' + partida.node.codigo"
                        [attr.id]="'contribuyentes_' + partida.node.codigo"
                        [readOnly]="mesCerrado"
                        inputmode="decimal"
                        (keydown)="permitirSoloNumeros($event)"
                        (paste)="sanearPegado($event, partida.node, 'contribuyentes')"
                        [(ngModel)]="partida.node.cantidadContribuyentesTexto"
                        (ngModelChange)="updateCampo(partida.node, 'contribuyentes', $event)"
                        [ngModelOptions]="{ standalone: true }"
                      />
                    </ng-container>
                    <ng-template #sinDatoContribuyentes>
                      <span class="valor-inhabilitado">N/A</span>
                    </ng-template>
                  </td>
                  <td *ngIf="partida.node.carga" class="cantidad">
                    <ng-container *ngIf="!partida.node.soloImporte; else sinDatoPagaron">
                      <input
                        type="text"
                        class="cantidad-input"
                        [class.input-error]="partida.node.errorPagaron"
                        [name]="'pagaron_' + partida.node.codigo"
                        [attr.id]="'pagaron_' + partida.node.codigo"
                        [readOnly]="mesCerrado"
                        inputmode="decimal"
                        (keydown)="permitirSoloNumeros($event)"
                        (paste)="sanearPegado($event, partida.node, 'pagaron')"
                        [(ngModel)]="partida.node.cantidadPagaronTexto"
                        (ngModelChange)="updateCampo(partida.node, 'pagaron', $event)"
                        [ngModelOptions]="{ standalone: true }"
                      />
                    </ng-container>
                    <ng-template #sinDatoPagaron>
                      <span class="valor-inhabilitado">N/A</span>
                    </ng-template>
                  </td>
                </tr>
              </ng-container>
            </ng-container>
          </tbody>
          <tfoot>
            <tr>
              <td class="total-label">TOTAL</td>
              <td class="total-valor">
                <strong>{{ totalImportes | number: '1.0-2' }}</strong>
              </td>
              <td class="total-placeholder">—</td>
              <td class="total-placeholder">—</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="acciones">
        <button type="submit" [disabled]="mesCerrado || cargandoPartidas || errorAlCargarPartidas || guardando">
          <mat-icon aria-hidden="true">save</mat-icon>
          <ng-container *ngIf="!guardando; else guardandoTexto">
            <span>Guardar cambios</span>
          </ng-container>
          <ng-template #guardandoTexto>
            <span>Guardando...</span>
          </ng-template>
        </button>
        <button
          type="button"
          (click)="generarInforme()"
          [disabled]="mesCerrado || cargandoPartidas || errorAlCargarPartidas || guardando || descargandoInforme"
        >
          <mat-icon aria-hidden="true">{{ descargandoInforme ? 'hourglass_top' : 'picture_as_pdf' }}</mat-icon>
          <ng-container *ngIf="!descargandoInforme; else generandoInformeTexto">
            <span>Generar informe</span>
          </ng-container>
          <ng-template #generandoInformeTexto>
            <span>Generando informe...</span>
          </ng-template>
        </button>
      </div>
      <p class="acciones__helper" role="note">
        <span class="acciones__helper-icon" aria-hidden="true">!</span>
        <span>
          <strong>Importante:</strong>
          guardá los cambios antes de generar el informe para visualizarlo con los datos actualizados.
        </span>
      </p>
    </form>

    <div class="guardando-overlay" *ngIf="guardando" aria-live="assertive">
      <div class="guardando-overlay__content">
        <span class="guardando-overlay__spinner" aria-hidden="true"></span>
        <span class="guardando-overlay__label">Guardando cambios...</span>
      </div>
    </div>
  </section>

  <section
    class="recursos-card recursos-card--masiva gastos-card gastos-card--masiva"
    *ngIf="vistaActual === 'masiva'"
    id="panel-masiva"
    role="tabpanel"
    aria-labelledby="tab-masiva"
  >
    <header class="recursos-card__header">
      <div>
        <h2>Importar recursos desde un arhcivo</h2>
        <p>Subí un archivo CSV con los importes percibidos y la información de contribuyentes para este período.</p>
      </div>
    </header>

    <div class="carga-masiva__layout">
      <section class="import-info-card" aria-label="Instrucciones para preparar el archivo">
        <h3>¿Cómo preparar el archivo?</h3>
        <ul>
          <li>Descargá la plantilla base y completala con los datos de tu municipio.</li>
          <li>Mantené las columnas <code>codigo_partida</code>, <code>descripcion</code>, <code>importe_percibido</code>, <code>total_contribuyentes</code> y <code>contribuyentes_pagaron</code>.</li>
          <li>Revisá las partidas con descripción <code>NO CARGAR</code>, las mismas serán ignoradas si se completan</li>
          <li>Las partidas sin <code>importe_percibido</code>, <code>contribuyentes_pagaron</code> y <code>total_contribuyentes</code> serán ignoradas.</li>
          <li>Las partidas que solo requieren importe están marcadas como <code>NO TC/CP</code>. Dejar vacías las columnas de contribuyentes para estas partidas.</li>
          <li>Guardá el archivo en formato CSV con codificación UTF-8.</li>
        </ul>
        <a class="plantilla-link" [href]="plantillaRecursosCsvUrl" download>
          <mat-icon aria-hidden="true">download</mat-icon>
          <span>Descargar plantilla CSV</span>
        </a>
      </section>

      <div class="carga-masiva__upload" aria-live="polite">
        <label class="upload-dropzone" [class.upload-dropzone--file]="archivoMasivoSeleccionado">
          <input
            #archivoCsv
            class="upload-dropzone__input"
            type="file"
            accept=".csv"
            (change)="onArchivoSeleccionado($event, archivoCsv)"
          />
          <div class="upload-dropzone__content" *ngIf="!archivoMasivoSeleccionado">
            <mat-icon aria-hidden="true">cloud_upload</mat-icon>
            <p>Arrastrá tu archivo CSV o <span>buscalo en tu equipo</span>.</p>
            <small>Tamaño recomendado máximo: 5&nbsp;MB.</small>
          </div>
          <div class="upload-dropzone__content upload-dropzone__content--file" *ngIf="archivoMasivoSeleccionado">
            <mat-icon aria-hidden="true">description</mat-icon>
            <div>
              <strong>{{ archivoMasivoSeleccionado.name }}</strong>
              <small *ngIf="previsualizacionMasiva.length">{{ obtenerTotalFilasMasivas() }} filas detectadas</small>
            </div>
            <button type="button" class="upload-dropzone__replace" (click)="limpiarArchivoMasiva(archivoCsv)">
              Reemplazar archivo
            </button>
          </div>
        </label>

        <div class="upload-status" *ngIf="cargandoArchivoMasivo">
          <span class="upload-status__spinner" aria-hidden="true"></span>
          <span>Procesando archivo...</span>
        </div>
        <div class="upload-errores" *ngIf="erroresCargaMasiva.length && !cargandoArchivoMasivo">
          <h4>Revisá estas observaciones</h4>
          <ul>
            <li *ngFor="let error of erroresCargaMasiva">{{ error }}</li>
          </ul>
        </div>
      </div>
    </div>

    <section class="carga-masiva__preview" *ngIf="previsualizacionMasiva.length">
      <header class="carga-masiva__preview-header">
        <div>
          <h3>Previsualización</h3>
          <p>Confirmá que los datos coinciden con lo que querés enviar.</p>
        </div>
        <div class="carga-masiva__preview-meta">
          <span>{{ obtenerTotalFilasMasivas() }} filas</span>
          <span class="preview-flag preview-flag--error" *ngIf="erroresPrevisualizacionMasiva.length">Hay filas con errores</span>
        </div>
      </header>

      <div class="tabla-wrapper">
        <table class="recursos-tabla">
          <thead>
            <tr>
              <th>Codigo</th>
              <th>Descripcion</th>
              <th>Importe Percibido</th>
              <th>Total de Contribuyentes</th>
              <th>Contribuyentes que Pagaron</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="cargandoPartidas">
              <td colspan="6" class="tabla-info">
                <div class="tabla-loader" role="status" aria-live="polite">
                  <span class="tabla-loader__spinner" aria-hidden="true"></span>
                  <span class="tabla-loader__label">Cargando partidas...</span>
                </div>
              </td>
            </tr>
            <tr *ngIf="!cargandoPartidas && errorAlCargarPartidas">
              <td colspan="4" class="tabla-info tabla-info--error">No pudimos obtener las partidas. Intentá nuevamente.</td>
            </tr>
            <tr
              *ngIf="!cargandoPartidas && !errorAlCargarPartidas && partidasPlanas.length === 0"
            >
              <td colspan="4" class="tabla-info">No hay partidas de recursos disponibles.</td>
            </tr>
            <ng-container *ngIf="!cargandoPartidas && !errorAlCargarPartidas">
              <ng-container *ngFor="let partida of previsualizacionMasiva">
                <tr
                  [class.grupo]="!partida.node.carga"
                  [class.tiene-error]="partida.node.errorImporte || partida.node.errorContribuyentes || partida.node.errorPagaron"
                >
                  <td>
                    {{ partida.node.codigo }}
                  </td>
                  <td
                    [attr.colspan]="partida.node.carga ? null : 4"
                    [style.padding-left.px]="partida.nivel * 20 + 4"
                  >
                    <span
                      [class.partida-titulo]="!partida.node.carga"
                      [class.partida-item]="partida.node.carga"
                    >
                      {{ partida.node.descripcion }}
                    </span>
                  </td>
                  <td *ngIf="partida.node.carga" class="importe">
                    {{ partida.node.importePercibido }}
                  </td>
                  <td *ngIf="partida.node.carga" class="cantidad">
                    <ng-container *ngIf="!partida.node.soloImporte; else sinDatoContribuyentes">
                      {{ partida.node.cantidadContribuyentes }}
                    </ng-container>
                    <ng-template #sinDatoContribuyentes>
                      <span class="valor-inhabilitado">N/A</span>
                    </ng-template>
                  </td>
                  <td *ngIf="partida.node.carga" class="cantidad">
                    <ng-container *ngIf="!partida.node.soloImporte; else sinDatoPagaron">
                      {{ partida.node.cantidadPagaron }}
                    </ng-container>
                    <ng-template #sinDatoPagaron>
                      <span class="valor-inhabilitado">N/A</span>
                    </ng-template>
                  </td>
                  <td>
                    <ng-container *ngIf="partida.node.errorImporte">
                      <ul class="preview-list">
                        <li class="preview-error">{{ obtenerErrorPartida(partida.node.codigo) }}</li>
                      </ul>
                    </ng-container>
                    <ng-container *ngIf="!partida.node.errorImporte && partida.node.carga">
                      <span class="preview-ok">Listo para enviar</span>
                    </ng-container>
                  </td>
                </tr>
              </ng-container>
            </ng-container>
          </tbody>
          <tfoot *ngIf="!cargandoPartidas && !errorAlCargarPartidas">
            <tr>
              <td class="total-label" colspan="2" [style.textAlign]="'left'">TOTAL</td>
              <td class="total-valor">
                <strong>{{ obtenerTotalImportesMasivos() | number: '1.0-2' }}</strong>
              </td>
              <td class="total-placeholder">—</td>
              <td class="total-placeholder">—</td>
              <td class="total-placeholder"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <div class="carga-masiva__acciones acciones acciones--masiva">
      <button
        type="button"
        (click)="insertarRecursosMasivos()"
        [disabled]="erroresCargaMasiva.length || cargandoArchivoMasivo || erroresPrevisualizacionMasiva.length"
      >
        <mat-icon aria-hidden="true">cloud_done</mat-icon>
        <span>Subir lote</span>
      </button>
      <button
        type="button"
        (click)="limpiarArchivoMasiva(archivoCsv)"
        [disabled]="!archivoMasivoSeleccionado"
      >
        Limpiar selección
      </button>
    </div>

    <p class="carga-masiva__helper" *ngIf="erroresPrevisualizacionMasiva.length" role="note">
      Corregí los errores señalados en el archivo antes de continuar con la carga masiva.
    </p>
  </section>

  <app-loading-overlay [display]="guardando" label="Guardando cambios..."></app-loading-overlay>

  <div class="modal-backdrop" *ngIf="modalVisible">
    <div class="modal">
      <div class="modal__header">
        <h3>Informe de Recursos</h3>
        <button type="button" class="modal__close" (click)="cerrarModal()">
          &times;
        </button>
      </div>
      <p class="modal__subtitulo">
        {{ municipioNombre }} &mdash; {{ mesActualLabel }}
      </p>
      <table class="modal__tabla">
        <thead>
          <tr>
            <th>Partida</th>
            <th>Importe Percibido</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let partida of partidasPlanas">
            <tr [class.grupo]="!partida.node.carga">
              <td
                [attr.colspan]="partida.node.carga ? null : 2"
                [style.padding-left.px]="partida.nivel * 16"
              >
                <span [class.partida-titulo]="!partida.node.carga">
                  {{ partida.node.descripcion }}
                </span>
              </td>
              <td *ngIf="partida.node.carga" class="importe">
                {{ (partida.node.importePercibido ?? 0) | number: '1.0-2' }}
              </td>
            </tr>
          </ng-container>
        </tbody>
        <tfoot>
          <tr>
            <td class="total-label">TOTAL</td>
            <td class="total-valor">
              <strong>{{ totalImportes | number: '1.0-2' }}</strong>
            </td>
          </tr>
        </tfoot>
      </table>
      <div class="modal__acciones">
        <button type="button" (click)="cerrarModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
