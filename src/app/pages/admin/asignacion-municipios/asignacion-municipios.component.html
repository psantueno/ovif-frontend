<div class="asignacion-container">
  <app-admin-navbar [breadcrumbs]="breadcrumbs" backLink="/admin"></app-admin-navbar>

  <mat-card class="helper-card">
    <div class="helper-content">
      <h3><mat-icon class="helper-icon" color="primary">info</mat-icon> Asignar municipios a un usuario</h3>
      <ol>
        <li>Busca al usuario por nombre, usuario o correo.</li>
        <li>Selecciona al usuario para cargar sus municipios actuales.</li>
        <li>Marca o desmarca los municipios que desees asignar.</li>
        <li>Presiona "Guardar cambios" para confirmar la asignación.</li>
      </ol>
    </div>
  </mat-card>

  <mat-card class="buscador-card">
    <form [formGroup]="filtroForm" (ngSubmit)="buscarUsuarios()" class="buscador-form">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar usuario</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput formControlName="search" placeholder="Nombre, usuario o correo" />
      </mat-form-field>

      <button mat-raised-button type="submit" class="btn-accion">
        <mat-icon>search</mat-icon>
        Buscar
      </button>
    </form>
  </mat-card>

  <div class="contenido" *ngIf="busquedaEjecutada">
    <mat-card class="usuarios-card">
      <mat-card-header>
        <mat-icon class="header-icon">group</mat-icon>
        <mat-card-title>Usuarios</mat-card-title>
        <mat-card-subtitle>Selecciona un usuario para gestionar sus municipios.</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="estado" *ngIf="cargandoUsuarios">
          <mat-spinner diameter="32"></mat-spinner>
          <span>Buscando usuarios...</span>
        </div>

        <div class="estado" *ngIf="!cargandoUsuarios && usuarios.length === 0">
          <mat-icon>search_off</mat-icon>
          <span>No hay usuarios para mostrar.</span>
        </div>

        <mat-nav-list *ngIf="!cargandoUsuarios && usuarios.length > 0">
          <a mat-list-item *ngFor="let usuario of usuarios" (click)="seleccionarUsuario(usuario)"
            [class.activo]="selectedUsuario?.usuario_id === usuario.usuario_id">
            <div matListItemTitle class="usuario-nombre">
              {{ usuario.nombre }} {{ usuario.apellido }}
            </div>
            <div matListItemLine class="usuario-detalle">
              {{ usuario.usuario }} · {{ usuario.email }}
            </div>
            <mat-icon *ngIf="selectedUsuario?.usuario_id === usuario.usuario_id" class="usuario-seleccionado" color="primary">check_circle</mat-icon>
          </a>
        </mat-nav-list>
      </mat-card-content>
    </mat-card>

    <mat-card class="municipios-card" *ngIf="selectedUsuario">
      <mat-card-header>
        <mat-icon class="header-icon">map</mat-icon>
        <mat-card-title>Municipios asignados</mat-card-title>
        <mat-card-subtitle>
          {{ selectedUsuario.nombre }} {{ selectedUsuario.apellido }} · {{ selectedUsuario.usuario }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="acciones-top">
          <button mat-raised-button class="btn-accion" (click)="seleccionarTodos()">
            <mat-icon>checklist</mat-icon>
            Seleccionar todos
          </button>
          <button mat-raised-button class="btn-accion" (click)="limpiarSeleccion()">
            <mat-icon>close</mat-icon>
            Limpiar selección
          </button>
        </div>

        <mat-divider></mat-divider>

        <div class="estado" *ngIf="cargandoAsignaciones">
          <mat-spinner diameter="32"></mat-spinner>
          <span>Cargando asignación...</span>
        </div>

        <div class="lista-municipios" *ngIf="!cargandoAsignaciones">
          <div class="municipio-item" *ngFor="let municipio of municipios">
            <mat-checkbox [checked]="municipioSeleccionado(municipio.municipio_id)"
              (change)="toggleMunicipio($event, municipio.municipio_id)">
              {{ municipio.municipio_nombre }}
            </mat-checkbox>
          </div>

          <div class="sin-municipios" *ngIf="municipios.length === 0">
            <mat-icon>map_off</mat-icon>
            <span>No hay municipios configurados.</span>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-raised-button class="btn-accion" (click)="guardarAsignacion()"
          [disabled]="guardandoAsignacion || cargandoAsignaciones">
          <mat-icon>save</mat-icon>
          <ng-container *ngIf="!guardandoAsignacion; else guardando">
            Guardar cambios
          </ng-container>
        </button>
        <ng-template #guardando>
          Guardando...
        </ng-template>
      </mat-card-actions>
    </mat-card>

    <mat-card class="placeholder-card" *ngIf="!selectedUsuario">
      <mat-card-content>
        <mat-icon>person_search</mat-icon>
        <p>Busca y selecciona un usuario para asignar municipios.</p>
      </mat-card-content>
    </mat-card>
  </div>
</div>
